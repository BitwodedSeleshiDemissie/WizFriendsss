rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    function isSignedIn() {
      return request.auth != null;
    }

    function userRole() {
      return isSignedIn() ? (request.auth.token.role ?? get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role) : null;
    }

    function hasRole(role) {
      return userRole() == role;
    }

    function hasAnyRole(roles) {
      return roles.hasAny([userRole()]);
    }

    function isAdmin() {
      return hasRole("admin");
    }

    function isModerator() {
      return hasAnyRole(["moderator", "admin", "customer_service"]);
    }

    function isSupport() {
      return hasAnyRole(["customer_service", "admin"]);
    }

    match /users/{userId} {
      allow read: if isSignedIn() && (request.auth.uid == userId || isAdmin());
      allow create: if isSignedIn() && request.auth.uid == userId;
      allow update: if isSignedIn() && (request.auth.uid == userId || isAdmin());
      allow delete: if false;
    }

    match /groups/{groupId} {
      allow read: if true;
      allow create: if isSignedIn();
      allow update: if isSignedIn() && (isAdmin() || request.auth.uid == resource.data.createdBy || request.auth.uid == request.resource.data.createdBy);
    }

    match /groupMembers/{memberId} {
      allow read: if isSignedIn();
      allow write: if isSignedIn() && (
        request.auth.uid == request.resource.data.userId ||
        request.auth.uid == resource.data.userId ||
        isAdmin() ||
        isModerator() && (
          get(/databases/$(database)/documents/groupMembers/$(request.resource.data.groupId + "_" + request.auth.uid)).data.role in ["owner", "moderator"]
        )
      );
    }

    match /activities/{activityId} {
      allow read: if resource.data.visibility == "public" || (isSignedIn() && (
        resource.data.visibility == "group_only" &&
        get(/databases/$(database)/documents/groupMembers/$(resource.data.hostGroupId + "_" + request.auth.uid)).exists
      )) || isAdmin();
      allow create: if isSignedIn();
      allow update: if isSignedIn() && (
        isAdmin() ||
        request.auth.uid == resource.data.hostUserId ||
        (resource.data.hostGroupId != null && get(/databases/$(database)/documents/groupMembers/$(resource.data.hostGroupId + "_" + request.auth.uid)).data.role in ["owner", "moderator"])
      );
    }

    match /userActivityJoin/{docId} {
      allow read, write: if isSignedIn() && request.auth.uid == request.resource.data.userId;
    }

    match /userActivitySave/{docId} {
      allow read, write: if isSignedIn() && request.auth.uid == request.resource.data.userId;
    }

    match /posts/{postId} {
      allow read: if true;
      allow create: if isSignedIn();
      allow update, delete: if isSignedIn() && (
        request.auth.uid == resource.data.authorUserId ||
        isAdmin()
      );
    }

    match /ideas/{ideaId} {
      allow read: if true;
      allow create: if isSignedIn();
      allow update: if isSignedIn() && (
        request.auth.uid == resource.data.createdBy ||
        isSupport()
      );
    }

    match /ideaEndorse/{docId} {
      allow read: if isSignedIn();
      allow write: if isSignedIn() && request.auth.uid == request.resource.data.userId;
    }

    match /featuredAds/{adId} {
      allow read: if true;
      allow create: if isSignedIn();
      allow update: if isSignedIn() && (
        isSupport() ||
        request.auth.uid == resource.data.createdBy
      );
    }

    match /adAppears/{docId} {
      allow read: if true;
      allow write: if isSignedIn() && isSupport();
    }

    match /tickets/{ticketId} {
      allow read: if isSignedIn() && (
        request.auth.uid == resource.data.userId ||
        isSupport()
      );
      allow create: if isSignedIn();
      allow update: if isSignedIn() && (
        request.auth.uid == resource.data.userId ||
        isSupport()
      );
    }

    match /userDevices/{docId} {
      allow read: if false;
      allow write: if isSignedIn() && request.auth.uid == request.resource.data.userId;
    }
  }
}
